name: AACS Scheduled Meeting

on:
  schedule:
    # ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      agenda:
        description: 'Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)'
        required: false
        default: 'Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¯ÙˆØ±ÙŠ'
      debug:
        description: 'ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­'
        required: false
        default: 'false'
        type: boolean

jobs:
  meeting:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate configuration
      env:
        AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
        AI_API_KEY: ${{ secrets.AI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python -c "from core.config import Config; Config.validate(); print('âœ… Configuration valid')"
    
    - name: Run AACS Meeting
      env:
        AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
        AI_API_KEY: ${{ secrets.AI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        MEETING_AGENDA: ${{ github.event.inputs.agenda || 'Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¯ÙˆØ±ÙŠ Ù…Ø¬Ø¯ÙˆÙ„' }}
        DEBUG_MODE: ${{ github.event.inputs.debug || 'false' }}
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ø¬ØªÙ…Ø§Ø¹ AACS..."
        echo "ğŸ“… Ø§Ù„ÙˆÙ‚Øª: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ“‹ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©: $MEETING_AGENDA"
        
        python scripts/run_meeting.py
    
    - name: Commit meeting artifacts
      if: always()
      run: |
        git config --local user.email "aacs-bot@github.com"
        git config --local user.name "AACS Bot"
        
        # Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ø­Ø¯Ø«Ø©
        git add meetings/ board/ -A
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
        else
          git commit -m "ğŸ¤– AACS Meeting $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push
          echo "âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹"
        fi
    
    - name: Send notification on failure
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          MESSAGE="ğŸš¨ ÙØ´Ù„ Ø§Ø¬ØªÙ…Ø§Ø¹ AACS
          
          â° Ø§Ù„ÙˆÙ‚Øª: $(date -u '+%Y-%m-%d %H:%M UTC')
          ğŸ“‹ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©: ${{ github.event.inputs.agenda || 'Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¯ÙˆØ±ÙŠ Ù…Ø¬Ø¯ÙˆÙ„' }}
          ğŸ”— Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù…Ø¹Ø±ÙØ© Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„."
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML"
          
          echo "ğŸ“± ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ´Ù„"
        else
          echo "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Telegram"
        fi
    
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: aacs-failure-logs-${{ github.run_id }}
        path: |
          *.log
          logs/
        retention-days: 7