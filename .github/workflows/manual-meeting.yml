name: AACS Manual Meeting

on:
  workflow_dispatch:
    inputs:
      agenda:
        description: 'Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹'
        required: true
        default: 'Ø§Ø¬ØªÙ…Ø§Ø¹ ÙŠØ¯ÙˆÙŠ'
        type: string
      
      debug:
        description: 'ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­'
        required: false
        default: false
        type: boolean
      
      priority:
        description: 'Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹'
        required: false
        default: 'normal'
        type: choice
        options:
          - normal
          - high
          - urgent
      
      notify_telegram:
        description: 'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Telegram Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡'
        required: false
        default: true
        type: boolean

jobs:
  manual-meeting:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Validate configuration
      env:
        AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
        AI_API_KEY: ${{ secrets.AI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        python -c "from core.config import Config; Config.validate(); print('âœ… Configuration valid')"
    
    - name: Display meeting info
      run: |
        echo "ğŸ¯ Ø§Ø¬ØªÙ…Ø§Ø¹ AACS ÙŠØ¯ÙˆÙŠ"
        echo "ğŸ“‹ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©: ${{ github.event.inputs.agenda }}"
        echo "ğŸ”§ ÙˆØ¶Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­: ${{ github.event.inputs.debug }}"
        echo "âš¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${{ github.event.inputs.priority }}"
        echo "ğŸ“± Ø¥Ø´Ø¹Ø§Ø± Telegram: ${{ github.event.inputs.notify_telegram }}"
        echo "ğŸ‘¤ Ø§Ù„Ù…Ø´ØºÙ„: ${{ github.actor }}"
        echo "ğŸ“… Ø§Ù„ÙˆÙ‚Øª: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
    
    - name: Run AACS Manual Meeting
      env:
        AI_PROVIDER: ${{ secrets.AI_PROVIDER }}
        AI_API_KEY: ${{ secrets.AI_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        MEETING_AGENDA: ${{ github.event.inputs.agenda }}
        DEBUG_MODE: ${{ github.event.inputs.debug }}
        MEETING_PRIORITY: ${{ github.event.inputs.priority }}
        TRIGGERED_BY: ${{ github.actor }}
        MANUAL_EXECUTION: 'true'
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ..."
        python scripts/run_meeting.py
    
    - name: Commit meeting artifacts
      if: always()
      run: |
        git config --local user.email "aacs-bot@github.com"
        git config --local user.name "AACS Bot"
        
        # Ø¥Ø¶Ø§ÙØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ø­Ø¯Ø«Ø©
        git add meetings/ board/ -A
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
        if git diff --staged --quiet; then
          echo "Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
        else
          COMMIT_MSG="ğŸ¯ AACS Manual Meeting by ${{ github.actor }} - $(date -u '+%Y-%m-%d %H:%M UTC')
          
          ğŸ“‹ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©: ${{ github.event.inputs.agenda }}
          âš¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${{ github.event.inputs.priority }}"
          
          git commit -m "$COMMIT_MSG"
          git push
          echo "âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø®Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ"
        fi
    
    - name: Send success notification
      if: success() && github.event.inputs.notify_telegram == 'true'
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          MESSAGE="âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ø¬ØªÙ…Ø§Ø¹ AACS Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¨Ù†Ø¬Ø§Ø­
          
          ğŸ‘¤ Ø§Ù„Ù…Ø´ØºÙ„: ${{ github.actor }}
          â° Ø§Ù„ÙˆÙ‚Øª: $(date -u '+%Y-%m-%d %H:%M UTC')
          ğŸ“‹ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©: ${{ github.event.inputs.agenda }}
          âš¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${{ github.event.inputs.priority }}
          ğŸ”— Ø§Ù„ØªÙØ§ØµÙŠÙ„: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹."
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML"
          
          echo "ğŸ“± ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­"
        else
          echo "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Telegram"
        fi
    
    - name: Send failure notification
      if: failure()
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
          MESSAGE="ğŸš¨ ÙØ´Ù„ Ø§Ø¬ØªÙ…Ø§Ø¹ AACS Ø§Ù„ÙŠØ¯ÙˆÙŠ
          
          ğŸ‘¤ Ø§Ù„Ù…Ø´ØºÙ„: ${{ github.actor }}
          â° Ø§Ù„ÙˆÙ‚Øª: $(date -u '+%Y-%m-%d %H:%M UTC')
          ğŸ“‹ Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©: ${{ github.event.inputs.agenda }}
          âš¡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${{ github.event.inputs.priority }}
          ğŸ”— Ø§Ù„Ø³Ø¬Ù„Ø§Øª: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù…Ø¹Ø±ÙØ© Ø³Ø¨Ø¨ Ø§Ù„ÙØ´Ù„."
          
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="HTML"
          
          echo "ğŸ“± ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ´Ù„"
        else
          echo "âš ï¸ Ù„Ù… ÙŠØªÙ… ØªÙƒÙˆÙŠÙ† Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Telegram"
        fi
    
    - name: Upload artifacts on completion
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: aacs-manual-meeting-${{ github.run_id }}
        path: |
          meetings/
          board/
          logs/
        retention-days: 30